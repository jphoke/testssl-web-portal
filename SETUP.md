# SSL Test Portal - Setup Guide

This guide provides detailed instructions for setting up the SSL Test Portal in various environments.

## Prerequisites

- Docker Engine 20.10 or newer
- Docker Compose v2.0 or newer
- At least 2GB RAM
- 5GB disk space
- Internet connection (for pulling images and testssl.sh)

## Quick Setup (Recommended)

1. **Clone the repository**
   ```bash
   git clone [your-repo-url]
   cd [repo-name]
   ```

2. **Run the deployment script**
   ```bash
   chmod +x clean-deploy.sh
   ./clean-deploy.sh
   ```
   
   The script will:
   - Set up all required services
   - Generate a secure secret key automatically
   - **Prompt you for a secure database password** (minimum 12 characters)
   - Start all containers

3. **Access the portal**
   - Web UI: http://localhost:3000
   - API: http://localhost:8000/docs (FastAPI documentation)

That's it! The script handles everything automatically.

## Manual Setup

If you prefer to set up manually or need to customize:

### 1. Environment Configuration

```bash
# Copy the example environment file
cp .env.example .env

# Generate a secure secret key
SECRET_KEY=$(openssl rand -hex 32)

# Update the .env file with your secret key
# On macOS:
sed -i '' "s/your-secret-key-here-use-openssl-rand-hex-32/$SECRET_KEY/" .env

# On Linux:
sed -i "s/your-secret-key-here-use-openssl-rand-hex-32/$SECRET_KEY/" .env

# IMPORTANT: Update the database password
# Replace 'changeme123' with a secure password (12+ characters)
# Edit .env and change DB_PASSWORD=changeme123 to your secure password
```

### 2. Create Required Directories

```bash
mkdir -p logs results
```

### 3. Build Docker Images

```bash
docker compose build
```

### 4. Start Services

```bash
docker compose up -d
```

### 5. Verify Deployment

```bash
# Check all services are running
docker compose ps

# Test the API health endpoint
curl http://localhost:8000/api/health
```

## Configuration Options

### Environment Variables (.env)

```bash
# Database (REQUIRED - must be changed from default)
DB_PASSWORD=CHANGE_THIS_TO_SECURE_PASSWORD  # Minimum 12 characters

# Application (auto-generated by deployment scripts)
SECRET_KEY=your-secret-key-here-use-openssl-rand-hex-32

# Redis
REDIS_URL=redis://redis:6379/0

# Celery
CELERY_BROKER_URL=redis://redis:6379/0
```

**Security Notes:**
- The deployment scripts will enforce secure passwords
- Default passwords like "changeme" or "changeme123" are not allowed
- Database password must be at least 12 characters
- Secret key is automatically generated using OpenSSL

### Port Configuration

Default ports (can be changed in docker-compose.yml):
- Frontend: 3000
- API: 8000

### Resource Limits

Adjust in docker-compose.yml if needed:
```yaml
services:
  worker:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
```

## Production Deployment

### 1. Security Hardening

- **Passwords**: Already enforced by deployment scripts (12+ characters)
- **CORS**: Currently allows all origins - should be restricted in production
- **Rate Limiting**: Implement nginx rate limiting (see TODO.md)
- **Network Isolation**: Use Docker networks to isolate services
- **Regular Updates**: Keep testssl.sh and dependencies updated

### 2. HTTPS Setup (with Nginx)

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. Firewall Rules

```bash
# Allow only HTTPS from outside
ufw allow 443/tcp
ufw deny 3000/tcp
ufw deny 8000/tcp
```

### 4. Backup Setup

```bash
# Create backup script
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backups/ssltestportal"
DATE=$(date +%Y%m%d_%H%M%S)

# Backup database
docker compose exec -T postgres pg_dump -U ssluser ssltestportal | \
    gzip > "$BACKUP_DIR/db_$DATE.sql.gz"

# Backup results
tar czf "$BACKUP_DIR/results_$DATE.tar.gz" results/

# Keep only last 30 days
find "$BACKUP_DIR" -type f -mtime +30 -delete
EOF

chmod +x backup.sh

# Add to crontab
crontab -e
# Add: 0 2 * * * /path/to/backup.sh
```

## Troubleshooting

### Services Won't Start

```bash
# Check logs
docker compose logs

# Check specific service
docker compose logs worker

# Restart everything
docker compose down
docker compose up -d
```

### Database Connection Issues

```bash
# Check PostgreSQL is running
docker compose ps postgres

# Test connection
docker compose exec postgres psql -U ssluser -d ssltestportal -c "SELECT 1;"
```

### Scans Not Processing

```bash
# Check Redis
docker compose exec redis redis-cli ping

# Check Celery workers
docker compose logs worker | grep "ready"

# Check job queue
docker compose exec redis redis-cli -a changeme LLEN celery
```

### Port Conflicts

If ports 3000 or 8000 are in use:

```yaml
# Edit docker-compose.yml
services:
  frontend:
    ports:
      - "3001:80"  # Change 3000 to 3001
  
  app:
    ports:
      - "8001:8000"  # Change 8000 to 8001
```

## Maintenance

### Regular Updates

```bash
# Update testssl.sh
docker compose build --no-cache worker

# Update all services
docker compose down
git pull
docker compose build
docker compose up -d
```

### Log Rotation

```bash
# Add to /etc/logrotate.d/ssltestportal
/path/to/ssltestportal/logs/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
}
```

### Monitoring

```bash
# Simple health check script
cat > monitor.sh << 'EOF'
#!/bin/bash
if ! curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
    echo "SSL Test Portal is down!" | mail -s "Alert" admin@example.com
fi
EOF

# Add to crontab for every 5 minutes
*/5 * * * * /path/to/monitor.sh
```

## Support

For issues, please check:
1. The logs: `./debug.sh`
2. The documentation: README.md, CLAUDE.md
3. GitHub issues: [your-repo-url]/issues